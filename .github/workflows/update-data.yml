name: Update Algolia from Google Sheets
on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Download CSV and Update Algolia
        env:
          ALGOLIA_APP_ID: ${{ X02D3JQ3LS }}
          ALGOLIA_ADMIN_KEY: ${{ 34b326537020e7362d2b85bfb7600b6f }}
          ALGOLIA_INDEX: ${{ hwaseong }}
        run: |
          curl -L "https://docs.google.com/spreadsheets/d/1TqArMJXSNRz9AJAJ0NNHYmQQv5Gh5TbNuNNqD107O1Y/export?format=csv" > data.csv
          
          npm init -y
          npm install algoliasearch csv-parser
          
          cat > update-algolia.js << 'EOF'
          const algoliasearch = require('algoliasearch');
          const csv = require('csv-parser');
          const fs = require('fs');
          
          const client = algoliasearch(
            process.env.ALGOLIA_APP_ID,
            process.env.ALGOLIA_ADMIN_KEY
          );
          const index = client.initIndex(process.env.ALGOLIA_INDEX);
          
          const records = [];
          
          fs.createReadStream('data.csv')
            .pipe(csv())
            .on('data', (data) => {
              data.objectID = data.카드번호 || `card_${records.length + 1}`;
              records.push(data);
            })
            .on('end', async () => {
              try {
                await index.replaceAllObjects(records);
                console.log(`✅ Algolia 업데이트: ${records.length}개`);
              } catch (error) {
                console.error('❌ 실패:', error);
              }
            });
          EOF
          
          node update-algolia.js
