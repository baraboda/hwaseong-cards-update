name: Update Algolia from Google Sheets
on:
  schedule:
    - cron: '0 0,12 * * *'
  workflow_dispatch:
jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Update Algolia
        env:
          ALGOLIA_APP_ID: "X02D3JQ3LS"
          ALGOLIA_ADMIN_KEY: "9796152cd8535860c759a6300d53c352"
        run: |
          curl -L "https://docs.google.com/spreadsheets/d/1TqArMJXSNRz9AJAJ0NNHYmQQv5Gh5TbNuNNqD107O1Y/export?format=csv&gid=0" > data.csv
          
          npm init -y
          npm install algoliasearch@4
          
          cat > update-algolia.js << 'EOF'
          const algoliasearch = require('algoliasearch');
          const fs = require('fs');
          
          const client = algoliasearch(
            process.env.ALGOLIA_APP_ID,
            process.env.ALGOLIA_ADMIN_KEY
          );
          const index = client.initIndex('hwaseong');
          
          // CSV 파일 직접 파싱
          const fileContent = fs.readFileSync('data.csv', 'utf8');
          const lines = fileContent.split('\n');
          const headers = lines[0].split(',');  // 탭으로 구분
          const records = [];
          
          console.log('헤더:', headers);
          console.log('전체 줄 수:', lines.length);
          
          for (let i = 1; i < lines.length; i++) {
            if (lines[i].trim()) {
              const values = lines[i].split(',');
              const record = {};
              
              headers.forEach((header, index) => {
                const cleanHeader = header.trim();
                record[cleanHeader] = values[index] ? values[index].trim() : '';
              });
              
              if (record['카드번호']) {
                record.objectID = record['카드번호'];
                records.push(record);
              }
            }
          }
          
          console.log('파싱된 레코드 수:', records.length);
          console.log('첫 번째 레코드:', JSON.stringify(records[0], null, 2));
          
          if (records.length > 0) {
            index.replaceAllObjects(records)
              .then(() => {
                console.log(`✅ Algolia 업데이트: ${records.length}개`);
              })
              .catch(error => {
                console.error('❌ 실패:', error);
                process.exit(1);
              });
          } else {
            console.error('파싱된 레코드가 없습니다');
            process.exit(1);
          }
          EOF
          
          node update-algolia.js
