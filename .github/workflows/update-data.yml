name: Update Data from Google Sheets
on:
  schedule:
    - cron: '0 0,12 * * *'  # ë§¤ì¼ ìì •, ì •ì˜¤ (í•œêµ­ì‹œê°„ ì˜¤ì „9ì‹œ, ì˜¤í›„9ì‹œ)
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
      
      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'
      
      - name: Download CSV from Google Sheets
        run: |
          curl -L "https://docs.google.com/spreadsheets/d/1TqArMJXSNRz9AJAJ0NNHYmQQv5Gh5TbNuNNqD107O1Y/export?format=csv" > hwaseong.csv
          echo "âœ… í™”ì„±ì‹œ ë°ì´í„° ë‹¤ìš´ë¡œë“œ ì™„ë£Œ"
          echo "ì´ $(wc -l < hwaseong.csv) ì¤„"
      
      - name: Convert CSV to JSON
        run: |
          npm init -y
          npm install csv-parser
          
          cat > convert.js << 'EOF'
          const fs = require('fs');
          const csv = require('csv-parser');
          
          const results = [];
          fs.createReadStream('hwaseong.csv')
            .pipe(csv())
            .on('data', (data) => {
              // ê° ë ˆì½”ë“œì— ê³ ìœ  ID ì¶”ê°€
              data.id = data.ì¹´ë“œë²ˆí˜¸ || `card_${results.length + 1}`;
              results.push(data);
            })
            .on('end', () => {
              // JSON íŒŒì¼ë¡œ ì €ì¥
              fs.writeFileSync('data.json', JSON.stringify(results, null, 2));
              console.log(`âœ… ${results.length}ê°œ ë ˆì½”ë“œë¥¼ JSONìœ¼ë¡œ ë³€í™˜ ì™„ë£Œ`);
              
              // í†µê³„ íŒŒì¼ ìƒì„±
              const stats = {
                lastUpdate: new Date().toISOString(),
                totalRecords: results.length,
                updateTime: new Date().toLocaleString('ko-KR', { timeZone: 'Asia/Seoul' })
              };
              fs.writeFileSync('stats.json', JSON.stringify(stats, null, 2));
            });
          EOF
          
          node convert.js
      
      - name: Commit and push changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data.json stats.json
          git diff --quiet && git diff --staged --quiet || (
            git commit -m "ğŸ“Š ë°ì´í„° ì—…ë°ì´íŠ¸: $(date +'%Y-%m-%d %H:%M')"
            git push
          )
